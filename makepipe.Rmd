---
title: "R Notebook"
output: html_document
---


```{r}
library(stringr)
my_render <- function(notebook_path , set_params = list()) 
  {

  report = get_output(script = notebook_path)$report
  input = get_input(notebook_path)
  output = get_output(notebook_path)

  set_params[["data_out_dir"]] = dirname(report) %s+% "/"
  message("Rendering to:")
  message(dirname(report))
  
  job::job({
    knitr::opts_knit$set(progress = TRUE, verbose = TRUE)
    source("./.Rprofile")
    rmarkdown::render(
      input = notebook_path,
      output_format = "html_document",
      output_file = report,
      knit_root_dir = getwd(),
      output_dir = dirname(report),
      params = set_params
    )
    job::export("none")
  }, import = c(notebook_path,report,set_params,input,output), packages = NULL,title = notebook_path)
}
```




```{r}
library(makepipe)
makepipe::reset_pipeline()
pipe <- get_pipeline()
source("./pipe.R")


make_with_recipe(
  recipe = my_render(notebook_path = "./Notebooks/HMSC/01_preprocess/01_create_data.Rmd"),
    targets = unlist(get_output("./Notebooks/HMSC/01_preprocess/01_create_data.Rmd")),
    dependencies = unlist(get_input("./Notebooks/HMSC/01_preprocess/01_create_data.Rmd")),
    label = "create_data",build = F
)


# 02_Cancer_filtering.Rmd
script = "./Notebooks/HMSC/01_preprocess/02_Cancer_filtering.Rmd"
make_with_recipe(
  recipe = my_render(notebook_path ="./Notebooks/HMSC/01_preprocess/02_Cancer_filtering.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "Cancer_filtering",build = F
)


#03_HMSC_cells_preprocess.Rmd
script = "./Notebooks/HMSC/01_preprocess/03_HMSC_cells_preprocess.Rmd"
make_with_recipe(
  recipe = my_render(notebook_path = "./Notebooks/HMSC/01_preprocess/03_HMSC_cells_preprocess.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "HMSC_cells_preprocess",build = F
)

#04_build_datasets.Rmd
script = "./Notebooks/HMSC/01_preprocess/04_build_datasets.Rmd"
make_with_recipe(
  recipe = my_render("./Notebooks/HMSC/01_preprocess/04_build_datasets.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "build_datasets",build = F
)


# #02_CNV.Rmd
# notebook_path = "./Notebooks/HMSC/02_CNV.Rmd"
# targets_and_depens = get_targets_and_depens(notebook_path)
# 
# 
# make_with_recipe(
#   recipe = my_render("./Notebooks/HMSC/02_CNV.Rmd"),
#     targets = c(targets_and_depens$targets),
#     dependencies = c(targets_and_depens$dependencies,notebook_path))


#03_Lum-Myo_HMSC.Rmd
script = "./Notebooks/HMSC/03_Lum-Myo_HMSC.Rmd"
make_with_recipe(
  recipe = my_render("./Notebooks/HMSC/03_Lum-Myo_HMSC.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "Lum-Myo_HMSC",build = F
)


#04_HMSC_vs_ACC.Rmd
script = "./Notebooks/HMSC/04_HMSC_vs_ACC.Rmd"

make_with_recipe(
  recipe = my_render( "./Notebooks/HMSC/04_HMSC_vs_ACC.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "HMSC_vs_ACC",build = F
)

#05_HPV_analysis.Rmd
script = "./Notebooks/HMSC/05_HPV_analysis.Rmd"
make_with_recipe(
  recipe = my_render( "./Notebooks/HMSC/05_HPV_analysis.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "HPV_analysis",build = F
)

#OPSCC preprocess
script = "./Notebooks/HPV_OPSCC_Analysis_PMC10191634/01_preprocess.Rmd"
make_with_recipe(
  recipe = my_render("./Notebooks/HPV_OPSCC_Analysis_PMC10191634/01_preprocess.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "OPSCC_preprocess",build = F
)


#OPSCC DEG
script = "./Notebooks/HPV_OPSCC_Analysis_PMC10191634/02_findDEG.Rmd"
make_with_recipe(
  recipe = my_render("./Notebooks/HPV_OPSCC_Analysis_PMC10191634/02_findDEG.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "OPSCC_DEG",build = F
)

#OPSCC volcano

script = "./Notebooks/HPV_OPSCC_Analysis_PMC10191634/03_volcano_plot.Rmd"
make_with_recipe(
  recipe = my_render("./Notebooks/HPV_OPSCC_Analysis_PMC10191634/03_volcano_plot.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "OPSCC_volcano",build = F
)


#OPSCC MYB fisher

script = "./Notebooks/HPV_OPSCC_Analysis_PMC10191634/05_MYB_HPV_fisher.Rmd"
make_with_recipe(
  recipe = my_render("./Notebooks/HPV_OPSCC_Analysis_PMC10191634/05_MYB_HPV_fisher.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "OPSCC_MYB_fisher",build = F
)

#OPSCC HMSC_HPV_signature

script = "./Notebooks/HPV_OPSCC_Analysis_PMC10191634/06_HMSC_HPV_signature.Rmd"

make_with_recipe(
  recipe = my_render("./Notebooks/HPV_OPSCC_Analysis_PMC10191634/06_HMSC_HPV_signature.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "OPSCC_MYB_fisher",build = F
)


# #TCGA built datasets
# notebook_path = "./Notebooks/TCGA/build_TCGA_datasets.Rmd"
# targets_and_depens = get_targets_and_depens(notebook_path)
# 
# make_with_recipe(
#   recipe = my_render("./Notebooks/TCGA/build_TCGA_datasets.Rmd"),
#     targets = c(targets_and_depens$targets),
#     dependencies = c(targets_and_depens$dependencies,notebook_path),
#   label = "TCGA built datasets")

#HPV signature compare
notebook_path = "./Notebooks/integrative_analysis/HPV_signature_compare.Rmd"
targets_and_depens = get_targets_and_depens(notebook_path)

make_with_recipe(
  recipe = my_render("./Notebooks/integrative_analysis/HPV_signature_compare.Rmd"),
    targets = c(targets_and_depens$targets),
    dependencies = c(targets_and_depens$dependencies,notebook_path),
  label = "HPV signature compare")


#TCGA HNSC
script = "./Notebooks/TCGA/OPSCC_TCGA.Rmd"
make_with_recipe(
  recipe = my_render("./Notebooks/TCGA/OPSCC_TCGA.Rmd"),
    targets = unlist(get_output(script)),
    dependencies = unlist(get_input(script)),
  label = "TCGA_HNSC_analysis",build = F
)



```


```{r}
pipe$build()
```


```{r}
show_pipeline(as = "visnetwork")
show_pipeline(as = "text")

```

