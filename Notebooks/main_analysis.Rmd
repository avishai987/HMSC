---
title: '`r rstudioapi::getSourceEditorContext()$path %>% basename() %>% gsub(pattern = "\\.Rmd",replacement = "")`' 
author: "Avishai Wizel"
date: '`r Sys.time()`'
output: 
  html_notebook: 
    code_folding: hide
    toc: yes
    toc_collapse: yes
    toc_float: 
      collapsed: FALSE
    number_sections: true
    toc_depth: 2
---


```{r}
script_name = rstudioapi::getSourceEditorContext()$path %>% basename() %>% gsub(pattern = "\\.Rmd",replacement = "")
output_dir_path = paste0("./Data_out/",script_name,"_",Sys.Date())
dir.create(output_dir_path)

```


# Functions

```{r warning=FALSE}
source_from_github(repositoy = "DEG_functions",version = "0.2.54")
source_from_github(repositoy = "HMSC_functions",version = "0.1.14",script_name = "functions.R")
source_from_github(repositoy = "cNMF_functions",version = "0.4.04",script_name = "cnmf_functions_V3.R")
source_from_github(repositoy = "sc_general_functions",version = "0.1.34",script_name = "functions.R")
library(hypeR)

```

# Data

```{r}
hmsc_cancer_cells = readRDS("./Data_out/03_HMSC_cells_preprocess_2024-05-12/acc1_cancer_cells_2500features_integrated_V5.RDS")
hmsc_acc_pri_cancer = readRDS("./Data_out/04_build_datasets_2024-05-12/hmsc_acc_pri_cancer_processed.RDS")
acc_pri = subset(hmsc_acc_pri_cancer,subset = patient.ident != "HMSC")
DefaultAssay(acc_pri) = "RNA"

all_cells = readRDS("./Data_out/01_create_data_2024-05-09/acc_tpm_nCount_mito_no146_15k_with_ACC1.RDS")
genesets_h  = getGmt("./Input_data/h.all.v7.0.symbols.pluscc.gmt")

# luminal_pathways = c("CHARAFE_BREAST_CANCER_LUMINAL_VS_BASAL_DN","CHARAFE_BREAST_CANCER_LUMINAL_VS_BASAL_UP","CHARAFE_BREAST_CANCER_LUMINAL_VS_MESENCHYMAL_DN","CHARAFE_BREAST_CANCER_LUMINAL_VS_MESENCHYMAL_UP","HUPER_BREAST_BASAL_VS_LUMINAL_DN","LIM_MAMMARY_LUMINAL_PROGENITOR_UP","SMID_BREAST_CANCER_LUMINAL_B_UP" )
# 
# # add luminal pathways
# luminal_gs = msigdbr(species = "Homo sapiens") %>% as.data.frame() %>% dplyr::filter(gs_name %in% luminal_pathways)%>% dplyr::distinct(gs_name, gene_symbol) %>% as.data.frame()
```




# HMSC vs ACC

## UMAP

```{r}
DimPlot(hmsc_acc_pri_cancer,group.by = "patient.ident",label = T)
```

```{r}
FeaturePlot(object = hmsc_acc_pri_cancer,features = c("MYB"),pt.size = 1)
p = FeaturePlot(object = hmsc_acc_pri_cancer,features = c("kaye_acc_score"),pt.size = 1,combine = T)
p

```



```{r}
pdf(paste0(output_dir_path,"/kaye_acc_score_AllCancerCells.pdf"))
p
dev.off()
```

## enrichment analysis 

```{r fig.width=8, echo=TRUE,results='hide',fig.keep='all'}
hmsc_acc_pri_cancer = SetIdent(hmsc_acc_pri_cancer, value ="patient.ident")
acc_deg <-
  FindMarkers(
    hmsc_acc_pri_cancer,
    ident.1 = "HMSC",
    features = VariableFeatures(hmsc_acc_pri_cancer),
    densify = T,
    assay = "RNA",
    mean.fxn = function(x) {
      return(log(rowMeans(x) + 1, base = 2)) # change fun to calculate logFC in log space data (default to exponent data)
    }
  )

```

```{r}
library(biomaRt)
ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")
IDs <- rownames(acc_deg)
genedesc <- getBM(attributes=c('external_gene_name','description'), filters = 'external_gene_name', values = IDs, mart =ensembl)
acc_deg_desc = left_join(x = rownames_to_column(acc_deg),y = genedesc,by = c("rowname"= "external_gene_name"))
names(acc_deg_desc)[1] = "gene"
hmsc_up_genes = acc_deg_desc [acc_deg_desc$avg_log2FC>0,]
acc_up_genes = acc_deg_desc [acc_deg_desc$avg_log2FC<0,]
fwrite(hmsc_up_genes,file = "./Data/hmsc_up_genes.csv",row.names = F)
fwrite(acc_up_genes,file = "./Data/acc_up_genes.csv",row.names = F)

```

```{r fig.height=6, fig.width=6, results='asis'}
ranked_vec = acc_deg[,"avg_log2FC"]%>% setNames(rownames(acc_deg)) %>% na.omit() # make named vector
hyp_obj <-hypeR_fgsea(signature = ranked_vec,genesets = geneIds(genesets_h),up_only = F)

plt = hyp_dots(hyp_obj,merge = T,fdr = 0.2)
plt+ scale_y_discrete(limits = arrange(plt$data,signature,significance)[,"label"])+ scale_colour_gradient2(low = "red",mid = "black",high = "black",midpoint = 0.1)



```

```{r fig.height=4, fig.width=12, results='asis'}
plt = hyp_dots(hyp_obj,merge = F,fdr = 0.2)

plt1 = plt$up+ aes(color=nes)+ggtitle("Up in HMSC")+ scale_colour_gradient2(low = "#E53935",mid = "white",high = "#E53935",midpoint = 0,limits = c(-3,3))

plt2 = plt$dn+ aes(color=nes)+ggtitle("Down in HMSC")+  scale_colour_gradient2(low = "#E53935",mid = "white",high = "#E53935",midpoint = 0,limits = c(-3,3))



p = ggarrange(plt1,plt2,common.legend = T,nrow = 1,legend = "right")
p 
```




## Cell cycle score  {.tabset}



```{r results='hide'}
hallmark_name = "GO_MITOTIC_CELL_CYCLE"
acc_pri = FindVariableFeatures(object = acc_pri,nfeatures = 15000)
acc_pri = ScaleData(object = acc_pri,features = VariableFeatures(acc_pri))
geneIds= genesets_h[[hallmark_name]]@geneIds %>% intersect(VariableFeatures(acc_pri)) 
score <- apply(acc_pri@assays$RNA@scale.data[geneIds,],2,mean)
acc_pri=AddMetaData(acc_pri,score,hallmark_name)

hmsc_cancer_cells = FindVariableFeatures(object = hmsc_cancer_cells,nfeatures = 15000)
hmsc_cancer_cells = ScaleData(object = hmsc_cancer_cells,features = VariableFeatures(hmsc_cancer_cells))
geneIds= genesets_h[[hallmark_name]]@geneIds %>% intersect(VariableFeatures(hmsc_cancer_cells)) 
score <- apply(hmsc_cancer_cells@assays$integrated@scale.data[geneIds,],2,mean)
hmsc_cancer_cells=AddMetaData(hmsc_cancer_cells,score,hallmark_name)

```

```{r echo=TRUE, results='asis'}
acc_cc_scores = FetchData(object = acc_pri,vars = "GO_MITOTIC_CELL_CYCLE")
hmsc_cc_scores = FetchData(object = hmsc_cancer_cells,vars = "GO_MITOTIC_CELL_CYCLE")

distributions_plt = ggplot() +
  geom_density(aes(GO_MITOTIC_CELL_CYCLE, fill = "ACC"), alpha = .2, data = acc_cc_scores) +
  geom_density(aes(GO_MITOTIC_CELL_CYCLE, fill = "HMSC"), alpha = .2, data = hmsc_cc_scores) +
  scale_fill_manual(name = "Dataset", values = c(ACC = "red", HMSC = "green"))+ geom_vline(aes(xintercept=0.3),
            color="blue", linetype="dashed", size=1) +ggtitle("'GO_MITOTIC_CELL_CYCLE'  score distribution")

print_tab(plt = distributions_plt,title = "score distribution",subtitle_num = 3)

```


```{r echo=TRUE, results='asis'}
hmsc_cc_cells = (sum(hmsc_cancer_cells@meta.data[[hallmark_name]]> 0.3) /ncol(hmsc_cancer_cells)) %>% round(digits = 3)*100
acc_cc_cells = (sum(acc_pri@meta.data[[hallmark_name]]> 0.3)/ncol(acc_pri)) %>% round(digits = 3)*100
df = data.frame(Dataset = c("HMSC","ACC"), cycling_cells_percentage = c(hmsc_cc_cells,acc_cc_cells))
cycling_cells_plt = ggplot(data=df, aes(x=Dataset, y=cycling_cells_percentage)) +
  geom_text(aes(label=cycling_cells_percentage), vjust=0, color="black", size=3.5)+
  geom_bar(stat="identity")+ylab(" % cycling cells")+
  geom_bar(stat="identity", fill="steelblue")+
  theme_minimal() + ggtitle("Cycling cells count")

print_tab(plt = cycling_cells_plt,title = "# cycling cells",subtitle_num = 3)
```


```{r}
pdf(paste0(params$fig_out_dir,"/CC_distributions.pdf"))
distributions_plt
dev.off()

pdf(paste0(params$fig_out_dir,"/cycling_cells.pdf"))
cycling_cells_plt
dev.off()
```


```{r fig.height=8, fig.width=10, results='asis'}
print_tab(plt = 
            FeaturePlot(hmsc_acc_pri_cancer,features = c("MKI67","CDK1","MCM2","CDC20"))
          ,title = "CC genes",subtitle_num = 3)
```

## Cycling cells filtering {.tabset}
```{r warning=FALSE}
#add score to all acc cancer cells
# geneIds= genesets[[hallmark_name]]@geneIds %>% intersect(VariableFeatures(all_acc_cancer_cells,assay = "integrated")) 
# score <- apply(all_acc_cancer_cells@assays$integrated@scale.data[geneIds,],2,mean)

#add score to all acc cancer cells
cc_all = c(acc_pri$GO_MITOTIC_CELL_CYCLE, hmsc_cancer_cells$GO_MITOTIC_CELL_CYCLE) %>% as.data.frame()
hmsc_acc_pri_cancer=AddMetaData(hmsc_acc_pri_cancer,cc_all,hallmark_name)

#filter:
all_acc_cancer_cells_ccFiltered=hmsc_acc_pri_cancer[,hmsc_acc_pri_cancer@meta.data[[hallmark_name]]< 0.3]


min_threshold = min(hmsc_acc_pri_cancer$GO_MITOTIC_CELL_CYCLE)
max_threshold = max(hmsc_acc_pri_cancer$GO_MITOTIC_CELL_CYCLE)
```

```{r, results='asis'}
library(viridis)

print_tab(plt = FeaturePlot(object = hmsc_acc_pri_cancer,features = hallmark_name) + ggtitle("Before cc filtering") &
            scale_color_gradientn(colours = plasma(n = 10, direction = -1), limits = c(min_threshold, max_threshold))
          ,title = "Before CC filtering",subtitle_num = 3)


print_tab(plt = 
            FeaturePlot(object = all_acc_cancer_cells_ccFiltered,features = hallmark_name) + 
            ggtitle("After cc filtering") &
            scale_color_gradientn(colours = plasma(n = 10, direction = -1), limits = c(min_threshold, max_threshold))
          ,title = "After CC filtering" ,subtitle_num = 3)

```

# end

## DEG

```{r fig.width=8, echo=TRUE, results='asis',fig.keep='all'}
all_acc_cancer_cells_ccFiltered = SetIdent(all_acc_cancer_cells_ccFiltered, value ="patient.ident")
all_acc_cancer_cells_ccFiltered = FindVariableFeatures(all_acc_cancer_cells_ccFiltered,nfeatures = 15000,assay = "integrated")
acc_deg <-
  FindMarkers(
    all_acc_cancer_cells_ccFiltered,
    ident.1 = "HMSC",
    features = VariableFeatures(all_acc_cancer_cells_ccFiltered,assay = "integrated"),
    densify = T,
    verbose = T,
    slot = "data",
    mean.fxn = function(x) {
      return(log(rowMeans(x) + 1,base = 2)) # change func to calculate logFC in log space data (default to exponent data)
    },
    assay = "RNA"
  )
```



```{r fig.height=4, fig.width=12, results='asis'}
ranked_vec = acc_deg[,"avg_log2FC"]%>% setNames(rownames(acc_deg)) %>% na.omit() # make named vector
hyp_obj <-hypeR_fgsea(signature = ranked_vec,genesets = geneIds(genesets_h),up_only = F)

plt = hyp_dots(hyp_obj,merge = F,fdr = 0.2)

plt1 = plt$up+ aes(size=nes)+ggtitle("Up in HMSC")+ 
  guides(
    size = guide_legend(title="|NES|",reverse=T))

plt2 = plt$dn+ aes(size=nes)+ggtitle("Down in HMSC")+scale_size(trans = 'reverse')+
    guides(
    size = guide_legend(title="|NES|",reverse=F)) 

p = ggarrange(plt1,plt2,common.legend = T,nrow = 1,legend = "right")
p

```

```{r}
pdf(paste0(params$fig_out_dir,"/ACC_vs_HMSC_GSEA.pdf",width = 12,height = 4))
p
dev.off()
```

```{r fig.width=10}
# plot GSEA
args = list(
  name = c("up","dn"),
  color = c("dodgerblue","indianred2"),
  title  = c("Up in HMSC","Up in ACC")
)
p_list = list()

for (i in 1:2) {
  name = args$name[i]
  color = args$color[i]
  title = args$title[i]
  
  final_result = hyp_obj$data[[name]]$data
  final_result = final_result %>% filter(fdr<0.2) 
  final_result$fdr = -log10(final_result$fdr)
  p <- ggplot(data = final_result, aes(x = reorder(label,fdr),y = fdr)) +
    geom_bar(stat = "identity", fill = color)  +
    coord_flip() + 
    geom_hline(yintercept = -log10(0.05), colour = "black", linetype = "longdash", size = 0.8,alpha = 0.5)+
    xlab("Pathway") + 
      scale_fill_manual(drop = FALSE) + ylab("FDR") + 
      geom_text(aes_string(label = "label", y = 0), 
                size = 4, color = "black", position = position_dodge(1), 
                hjust = 0) +
    scale_y_continuous(labels = function(x) {parse(text = paste0("10^-",x))}, # set fdr format 10^-X
                       expand = expansion(mult = c(0, 0.1)))+ #expand to avoid cut off
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),axis.text.x = element_text(size = 10)) +  
    ggtitle(title)
  p_list[[name]] = p
  
}
p = p_list[[1]]+p_list[[2]]
p
```


```{r}
pdf(paste0(params$fig_out_dir,"/ACC_vs_HMSC_GSEA_barplot.pdf"),width = 10)
p
dev.off()
```



```{r}

volcano_plt = volcano_plot.2(de_genes = acc_deg,fdr_cutoff = 0.05,fc_cutoff = 2, ident1 = "HMSC",ident2 = "ACC",top_genes_text = 0)
volcano_plt
```






```{r}
pdf(paste0(params$fig_out_dir,"/volcano_plot_ACC_VS_HMSC.pdf"))
volcano_plt
dev.off()

```

```{r}
write.csv2(x = acc_deg,file = "./Figures/HMSC_vs_ACC_DEG.csv")
```





# HMSC analysis 
```{r}
DefaultAssay(hmsc_cancer_cells) = "integrated"
```

## UMAP 

```{r}
hmsc_cancer_cells = FindClusters(object = hmsc_cancer_cells,verbose = F,resolution = 0.5)
DimPlot(object = hmsc_cancer_cells,pt.size = 2)
```

## Scores 
```{r fig.height=8, fig.width=12}
FeaturePlot(object = hmsc_cancer_cells,features = c("MYB","JAG1"),pt.size = 2)+
DimPlot(object = hmsc_cancer_cells,group.by  = c("hpv33_positive"),pt.size = 2)

```





## NMF {.tabset}


```{python}
from cnmf import cNMF
import pickle
f = open('./Data/cNMF/batch_corrected_cnmf/cnmf_obj.pkl', 'rb')
cnmf_obj = pickle.load(f)
f.close()
```



```{r}
knitr::include_graphics("./Data/cNMF/batch_corrected_cnmf/BatchCorrected_NMF/BatchCorrected_NMF.k_selection.png")
```

```{python}
selected_k = 3
density_threshold = 0.1
cnmf_obj.consensus(k=selected_k, density_threshold=density_threshold,show_clustering=True)
usage_norm, gep_scores, gep_tpm, topgenes = cnmf_obj.load_results(K=selected_k, density_threshold=density_threshold)
```

```{r}
gep_scores = py$gep_scores
gep_tpm = py$gep_tpm
all_metagenes= py$usage_norm
```

## Harmony results {.tabset}



```{r fig.height=8, fig.width=10, results='asis'}
# Make metagene names
for (i in 1:ncol(all_metagenes)) {
  colnames(all_metagenes)[i] = "metagene." %>% paste0(i)
}

#add each metagene to metadata
for (i in 1:ncol(all_metagenes)) {
  metage_metadata = all_metagenes %>% select(i)
  hmsc_cancer_cells = AddMetaData(object = hmsc_cancer_cells,metadata = metage_metadata)
}
print_tab(plt = 
            FeaturePlot(object = hmsc_cancer_cells,features = colnames(all_metagenes),combine = T),
          title = "metagenes expression",subtitle_num = 2)

```

```{r}
pdf("./Figures/NMF_UMAP.pdf",height = 8,width = 10)
 FeaturePlot(object = hmsc_cancer_cells,features = colnames(all_metagenes),combine = T)
dev.off()

```

# GSEA

```{r fig.height=8, fig.width=10}

plotlist = list()
for (i in 1:ncol(gep_scores)) {
  ranked_vec = gep_scores %>% pull(i) %>%  setNames(rownames(gep_scores))
  hyp_obj <-hypeR_fgsea(signature = ranked_vec,genesets = geneIds(genesets_h),up_only = T)

  plt = hyp_dots(hyp_obj,merge = F,fdr = 0.2)+ aes(size=nes)+ggtitle(paste("Metagene", i))+ 
  guides(
    size = guide_legend(title="NES",reverse=T))
  plotlist[[i]] = plt
}
p = ggarrange(plotlist = plotlist,ncol = 2,nrow = 2,common.legend = T)
p
```

```{r}
pdf("./Figures/NMF_GSEA.pdf",height = 8,width = 10)
p
dev.off()

```


```{r fig.height=7, fig.width=10}

plotlist = list()
for (i in 1:ncol(gep_scores)) {
  ranked_vec = gep_scores %>% pull(i) %>%  setNames(rownames(gep_scores))
  hyp_obj <-hypeR_fgsea(signature = ranked_vec,genesets = geneIds(genesets_h),up_only = T)

  final_result = hyp_obj$data
  final_result = final_result %>% filter(fdr<0.2) %>% head(15) #filter non sigificant+ set maximum pathways
  final_result$fdr = -log10(final_result$fdr) 
  p <- ggplot(data = final_result, aes(x = reorder(label,fdr),y = fdr)) + #reorder pthways by fdr
    geom_bar(stat = "identity", fill = "dodgerblue")  +
    coord_flip() + 
    geom_hline(yintercept = -log10(0.05), colour = "black", linetype = "longdash", size = 0.8,alpha = 0.5)+ # add 0.05 interception
    xlab("Pathway") + 
      scale_fill_manual(drop = FALSE) + ylab("FDR") + 
      geom_text(aes_string(label = "label", y = 0), # add labels on the plot iself rather than on axis 
                size = 4, color = "black", position = position_dodge(1), 
                hjust = 0) +
    scale_y_continuous(labels = function(x) {parse(text = paste0("10^-",x))}, # set fdr format 10^-X
                       expand = expansion(mult = c(0, 0.1)))+ #expand to avoid cut off
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(),axis.text.x = element_text(size = 10)) +  
    ggtitle(paste("Metagene", i))
  
  plotlist[[i]] = p
}
p = ggarrange(plotlist = plotlist,ncol = 2,nrow = 2,common.legend = T)
p
```

```{r}
pdf("./Figures/NMF_GSEA_barplot.pdf",height = 7,width = 10)
p
dev.off()

```

```{r fig.height=10}
all_programs_top_genes = c()
for (i in 1:ncol(gep_scores)) {
  top_genes = gep_scores  %>%  arrange(desc(gep_scores[i])) #sort by score a
  top = head(rownames(top_genes), 20) #take top top_genes_num
  all_programs_top_genes = c(all_programs_top_genes,top)
}

data = FetchData(object = hmsc_cancer_cells, vars = all_programs_top_genes) %>% scale() %>% t()

annotation_data = FetchData(object = hmsc_cancer_cells, vars = colnames(all_metagenes))
col_fun = circlize::colorRamp2(c(0, 1), c("white", "red"))
column_ha = HeatmapAnnotation(df = annotation_data, col = list(metagene.1 = col_fun,metagene.2 = col_fun,metagene.3 = col_fun))

p = ComplexHeatmap::Heatmap(
  data,
  show_column_names = F,
  row_names_gp = grid::gpar(fontsize = 7),
  cluster_rows = F,
  top_annotation =
    column_ha,
  name = "Z-score expression"
)
  
p
```

```{r}
pdf("./Figures/NMF_heatmap.pdf",width = 10)
p
dev.off()

```




## Lum Myo score

```{r}
original_myo_genes = c( "TP63", "TP73", "CAV1", "CDH3", "KRT5", "KRT14", "ACTA2", "TAGLN", "MYLK", "DKK3")
original_lum_genes = c("KIT", "EHF", "ELF5", "KRT7", "CLDN3", "CLDN4", "CD24", "LGALS3", "LCN2", "SLPI" )
```

```{r fig.height=8, fig.width=12}
FeaturePlot(hmsc_cancer_cells,features = original_myo_genes)
FeaturePlot(hmsc_cancer_cells,features = original_lum_genes)

```


```{r}
acc_pri = SetIdent(acc_pri,value = "patient.ident")
calculate_score(dataset = acc_pri,myo_genes = original_myo_genes,lum_genes = original_lum_genes)
```

```{r}
calculate_score.2 <- function(dataset,myo_genes,lum_genes,lum_threshold =1 , myo_threshold = -1, return_density = F) {
  myoscore=FetchData(object =dataset,vars =  myo_genes,slot = "data") %>% rowMeans()
  lescore=FetchData(object =dataset,vars =  lum_genes,slot = "data") %>% rowMeans()
  correlation = cor(lescore,myoscore) %>% round(digits = 2)
  message("correlation of lum score and myo score:" %>% paste(correlation))
  
  
  original_myo_genes = c("TP63", "TP73", "CAV1", "CDH3", "KRT5", "KRT14", "ACTA2", "TAGLN", "MYLK", "DKK3")
  original_lum_genes = c("KIT", "EHF", "ELF5", "KRT7", "CLDN3", "CLDN4", "CD24", "LGALS3", "LCN2", "SLPI")
  orig_myoscore=FetchData(object =dataset,vars =  original_myo_genes,slot = "data") %>% rowMeans()
  orig_lescore=FetchData(object =dataset,vars =  original_lum_genes,slot = "data") %>% rowMeans()
  correlation_to_original_lum = cor(orig_lescore,lescore) %>% round(digits = 2)
  correlation_to_original_myo = cor(orig_myoscore,myoscore) %>% round(digits = 2)

  message("correlation of lum score and original lum score:" %>% paste(correlation_to_original_lum))
  message("correlation of myo score and original myo score:" %>% paste(correlation_to_original_myo))

  dataset=AddMetaData(dataset,lescore-myoscore,"luminal_over_myo")
  print(
    FeaturePlot(object = dataset,features = "luminal_over_myo")
  )
  data = FetchData(object = dataset,vars = "luminal_over_myo")

  
    p = data %>% 
    ggplot(aes( x=luminal_over_myo)) + 
    geom_density() +ylab("Density")+theme(  axis.title=element_text(size=12,face="bold"))+ xlab("Luminal-Myoepithelial spectrum")
    if (return_density) {
      return(p)
    } else{ print(p)}
  
lum_cells_num = subset(x = dataset,luminal_over_myo >(lum_threshold)) %>% ncol() /ncol(dataset)
myo_cells_num = subset(x = dataset,luminal_over_myo <(myo_threshold)) %>% ncol()/ncol(dataset)
df = data.frame(cell_type = c("myo_cells","lum_cells"),percentage = c(myo_cells_num,lum_cells_num))
ggplot(data=df, aes(x=cell_type, y=percentage)) +
  geom_bar(stat="identity") + ggtitle("ACC cell types")
}

```


## Original score of ACC1

```{r}
calculate_score.2(dataset = acc_pri,myo_genes = original_myo_genes,lum_genes = original_lum_genes,lum_threshold = 0,myo_threshold = 0)
```

```{r}
DefaultAssay(hmsc_cancer_cells) = "integrated"
```

```{r}
calculate_score.2(dataset = hmsc_cancer_cells,myo_genes = original_myo_genes,lum_genes = original_lum_genes,lum_threshold = 0,myo_threshold = 0)

p = calculate_score.2(dataset = hmsc_cancer_cells,myo_genes = original_myo_genes,lum_genes = original_lum_genes,lum_threshold = 0,myo_threshold = 0,return_density = T)
```


```{r}
pdf("./Figures/HMSC_myo_lum_spectrum.pdf")
p
dev.off()

```

```{r}
DefaultAssay(object = hmsc_cancer_cells) = "integrated"
```

```{r fig.height=5, fig.width=10}
library(circlize)
data = FetchData(object = hmsc_cancer_cells,vars = c(original_lum_genes))
myo_plt = ComplexHeatmap::Heatmap(matrix = cor(data),name = "pearson", col = colorRamp2(seq(-1, 1, length = 3), c("blue", "#EEEEEE", "red")), heatmap_legend_param = list(at = c(-1, 0, 1)),
    cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", cor(data)[i, j]), x, y, gp = gpar(fontsize = 7))
}, column_title = "HMSC luminal genes")

data = FetchData(object = acc_pri,vars = c(original_lum_genes))
lum_plt = ComplexHeatmap::Heatmap(matrix = cor(data),name = "pearson", col = colorRamp2(seq(-1, 1, length = 3), c("blue", "#EEEEEE", "red")), heatmap_legend_param = list(at = c(-1, 0, 1)),
    cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", cor(data)[i, j]), x, y, gp = gpar(fontsize = 7))
}, column_title = "ACC luminal genes")

p1 = grid.grabExpr(draw(myo_plt))
p2 = grid.grabExpr(draw(lum_plt))
p = ggarrange(p1,p2)
p
```
```{r}
pdf("./Figures/Luminal_genes_correlation.pdf",height = 5,width = 10)
p
dev.off()

```

Barplot

```{r}
hmsc_data = FetchData(object = hmsc_cancer_cells,vars = c(original_lum_genes)) %>% cor()
acc_data = FetchData(object = acc_pri,vars = c(original_lum_genes)) %>% cor()
acc_data_vector = acc_data[upper.tri(acc_data,diag=F)] %>% as_vector()
hmsc_data_vector = hmsc_data[upper.tri(hmsc_data,diag=F)] %>% as_vector()

all_correlation = data.frame(pearson = c(acc_data_vector,hmsc_data_vector),
                             data = c(rep("acc", length(acc_data_vector)), rep("hmsc", length(hmsc_data_vector))))

ggplot(all_correlation, aes(x=pearson, color=data,fill=data)) +
  geom_histogram( position="identity",alpha=0.5)
```

```{r fig.height=5, fig.width=10}
library(circlize)
data = FetchData(object = hmsc_cancer_cells,vars = c(original_myo_genes))
myo_plt = ComplexHeatmap::Heatmap(matrix = cor(data),name = "pearson", col = colorRamp2(seq(-1, 1, length = 3), c("blue", "#EEEEEE", "red")), heatmap_legend_param = list(at = c(-1, 0, 1)),
    cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", cor(data)[i, j]), x, y, gp = gpar(fontsize = 7))
}, column_title = "HMSC Myoepithelial  genes")

data = FetchData(object = acc_pri,vars = c(original_myo_genes))
lum_plt = ComplexHeatmap::Heatmap(matrix = cor(data),name = "pearson", col = colorRamp2(seq(-1, 1, length = 3), c("blue", "#EEEEEE", "red")), heatmap_legend_param = list(at = c(-1, 0, 1)),
    cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", cor(data)[i, j]), x, y, gp = gpar(fontsize = 7))
}, column_title = "ACC Myoepithelial  genes")

p1 = grid.grabExpr(draw(myo_plt))
p2 = grid.grabExpr(draw(lum_plt))
p = ggarrange(p1,p2)
p
```
```{r}
pdf("./Figures/Myo_genes_correlation.pdf",height = 5,width = 10)
p
dev.off()

```



